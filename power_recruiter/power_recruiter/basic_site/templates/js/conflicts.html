<script>
    GHOST_PIC = 'static/img/ghost.png';

    $('#conflicts_modal').on('hidden.bs.modal', function (e) {
        get_conflicts();
    });

    function get_conflicts() {
        $.get(
                '/candidate/get_conflicts/',
                function (data) {
                    if (data[0].length > 0) {
                        var img0 = data[0][0]['photo']['photo'];
                        var img1 = data[0][1]['photo']['photo'];
                        img0 = img0 ? img0 : GHOST_PIC;
                        img1 = img1 ? img1 : GHOST_PIC;
                        args = [];
                        args['img0'] = img0;
                        args['img1'] = img1;
                        args['name'] = data[0][0]['candidate_name']['candidate_name'];
                        args['state0'] = data[0][0]['state']['raw_state_name'];
                        args['state1'] = data[0][1]['state']['raw_state_name'];
                        args['id0'] = data[0][0]['id']['id'];
                        args['id1'] = data[0][1]['id']['id'];
                        args['linkedin0'] = data[0][0]['contact']['linkedin'];
                        args['linkedin1'] = data[0][1]['contact']['linkedin'];
                        args['goldenline0'] = data[0][0]['contact']['goldenline'];
                        args['goldenline1'] = data[0][1]['contact']['goldenline'];
                        args['email0'] = data[0][0]['contact']['email'];
                        args['email1'] = data[0][1]['contact']['email'];
                        show_conflicts_modal(args);
                        put_ids_modal(args['id0'], args['id1']);
                    }
                }
        );
    }

    function show_conflicts_modal(d) {
        var $conflicts_modal = $('#conflicts_modal');
        $('#conflict_modal_name').text(d['name']);
        $('#img0').attr('src', d['img0']);
        $('#img1').attr('src', d['img1']);
        $('#status0 a').text(d['state0']);
        $('#status1 a').text(d['state1']);

{#        if (!d['linkedin0'] && !d['linkedin1']) {#}
{#            $('#linkedin-div').hide()#}
{#        } else {#}
{#            $('#linkedin0 a').text(d['linkedin0']);#}
{#            $('#linkedin1 a').text(d['linkedin1']);#}
{#        }#}
{#        $('#goldenline0 a').text(d['goldenline0']);#}
{#        $('#goldenline1 a').text(d['goldenline1']);#}
{#        $('#email0 a').text(d['email0']);#}
{#        $('#email1 a').text(d['email1']);#}

        $conflicts_modal.modal('show');
        show_or_hide_section(d['linkedin0'], d['linkedin1'], '#linkedin0', '#linkedin1', '#linkedin-div');
        show_or_hide_section(d['goldenline0'], d['goldenline1'], '#goldenline0', '#goldenline1', '#goldenline-div');
        show_or_hide_section(d['email0'], d['email1'], '#email0', '#email1', '#email-div');
    }

    function show_or_hide_section(val0, val1, val0_div, val1_div, section_div) {
        if (!val0 && !val1) {
            $(section_div).hide();
        } else {
            show_or_hide_button(val0, val0_div);
            show_or_hide_button(val1, val1_div);

        }
    }

    function show_or_hide_button(val, div) {
        if (val) {
            $(div + ' a').text(val);
        } else {
            $(div + ' a').text('blank');
        }
    }

    function put_ids_modal(id0, id1) {
        $('#id0').val(id0);
        $('#id1').val(id1);
    }

    function checkImage(k) {
        $('#checked-img').val(k);
        $('#img'+k).addClass("checked");
        $('#img'+(1-k)).removeClass("checked");
    }

    function checkNav(hidden_id, div_id, k) {
        $(hidden_id).val(k);
        $(div_id+k).addClass("active");
        $(div_id+(1-k)).removeClass("active");
    }

    function merge(person_ids) {
        resolve_conflicts(person_ids, true);
    }

    function dont_merge(person_ids) {
        resolve_conflicts(person_ids, false);
    }

    function resolve_conflicts(merge) {
        var ids = get_ids_from_modal();
        var img = $('#checked-img').val();
        var state = $('#checked-status').val();
        var linkedin = $('#checked-linkedin').val();
        var goldenline = $('#checked-goldenline').val();
        var email = $('#checked-email').val();
        $.post(
                '/candidate/resolve_conflicts/',
                {
                    'ids': JSON.stringify(ids),
                    'img': img,
                    'state': state,
                    'linkedin': linkedin,
                    'goldenline': goldenline,
                    'email': email,
                    'merge': merge
                },
                function() { $('#conflicts_modal').modal('hide'); reloadData(); }
        );
    }

    function get_ids_from_modal() {
        return [$('#id0').val(), $('#id1').val()];
    }

    $('#conflicts_modal_merge').on('click', function (e) {
        resolve_conflicts(true);
    });

    $('#conflicts_modal_dont_merge').on('click', function (e) {
        resolve_conflicts(false);
    });

    get_conflicts();
</script>
